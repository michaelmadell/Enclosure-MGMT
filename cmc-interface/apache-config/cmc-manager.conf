<VirtualHost *:80>
    ServerName localhost
    ServerAdmin admin@localhost

    DocumentRoot /var/www/cmc-manager
    
    # Allow encoded slashes (at VirtualHost level, not in Location)
    AllowEncodedSlashes NoDecode
    
    <Directory /var/www/cmc-manager>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_URI} !^/api/
        RewriteRule ^ index.html [L]
    </Directory>

    # Proxy configuration for CMC API requests
    ProxyPreserveHost Off
    ProxyTimeout 60
    
    # Preserve request body for POST/PUT
    SetEnv proxy-sendcl 1
    
    # Enable SSL proxy for HTTPS CMCs
    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off
    
    # Enable CORS headers for API requests
    <LocationMatch "^/api/cmc/">
        Header always set Access-Control-Allow-Origin "*"
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
        Header always set Access-Control-Max-Age "3600"
    </LocationMatch>
    
    # Handle OPTIONS preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^/api/cmc/.*$ - [R=200,L]
    
    # Proxy pass with capture groups
    # Pattern: /api/cmc/{cmc-address}/{endpoint}
    # Example: /api/cmc/10.50.0.123/api/auth/token -> https://10.50.0.123/api/auth/token
    ProxyPassMatch "^/api/cmc/([^/]+)(.*)$" "https://$1$2" nocanon
    ProxyPassReverse "^/api/cmc/([^/]+)(.*)$" "https://$1$2"
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/cmc-manager-error.log
    CustomLog ${APACHE_LOG_DIR}/cmc-manager-access.log combined
    LogLevel warn proxy:trace1
</VirtualHost>
